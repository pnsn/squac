<div mat-dialog-title id="edit-title">
  <h3>{{ editMode ? "Edit Monitor" : "New Monitor" }}</h3>
  <button mat-icon-button (click)="cancel()" type="button">
    <mat-icon>close</mat-icon>
  </button>
</div>
<div mat-dialog-content id="edit-container">
  <form #monitorEditForm [formGroup]="monitorForm">
    <div id="monitor-edit-container">
      <mat-form-field hintLabel="Max 60 characters" class="large">
        <mat-label for="name">Monitor Name</mat-label>
        <input
          matInput
          #name
          maxLength="60"
          type="text"
          name="name"
          formControlName="name"
        />
        <mat-hint align="end">{{ name.value?.length || 0 }}/60</mat-hint>
      </mat-form-field>

      <div id="monitor-body">
        <div>
          <span>Alert if the</span>
          <mat-form-field class="xsmall">
            <mat-label>Statistic</mat-label>
            <mat-select formControlName="stat" name="stat">
              <mat-option *ngFor="let stat of stats" [value]="stat.value">
                {{ stat.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <span>of</span>
          <mat-form-field class="medium">
            <mat-label>Metric</mat-label>
            <mat-select
              formControlName="metric"
              name="metric"
              placeholder="metric"
            >
              <mat-option *ngFor="let m of metrics" [value]="m"
                >{{ m.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <span>measurements</span>
        </div>

        <ng-container formArrayName="triggers">
          <ng-container formGroupName="0">
            <div>
              <span>is</span>
              <mat-form-field class="xsmall">
                <mat-label for="value_operator">operator</mat-label>
                <mat-select
                  formControlName="value_operator"
                  name="value_operator"
                >
                  <mat-option
                    *ngFor="let o of value_operators"
                    [value]="o.value"
                  >
                    {{ o.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field class="xsmall">
                <mat-label for="val1">value:</mat-label>
                <input
                  matInput
                  type="number"
                  name="val1"
                  formControlName="val1"
                />
              </mat-form-field>
              <span> and </span>
              <mat-form-field class="xsmall">
                <mat-label for="val2">value:</mat-label>
                <input
                  matInput
                  type="number"
                  name="val2"
                  formControlName="val2"
                />
              </mat-form-field>
            </div>
            <div id="trigger-channels">
              <span>for</span>
              <mat-form-field class="xsmall">
                <mat-label for="num_channels_operator"
                  >num_channels_operator</mat-label
                >
                <mat-select
                  formControlName="num_channels_operator"
                  name="num_channels_operator"
                >
                  <mat-option
                    *ngFor="let n of num_channels_operators"
                    [value]="n.value"
                  >
                    {{ n.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field class="xsmall">
                <mat-label for="num_channels">num_channels:</mat-label>
                <input
                  matInput
                  type="number"
                  name="num_channels"
                  formControlName="num_channels"
                />
              </mat-form-field>
            </div>
          </ng-container>
        </ng-container>
        <div id="monitor-channels">
          <span>in</span>
          <mat-form-field class="medium">
            <mat-label> Channel Group </mat-label>
            <mat-select formControlName="channelGroup" name="channelGroup">
              <mat-option *ngFor="let c of channelGroups" [value]="c"
                >{{ c.name }} ({{ c.channelIds.length }} channels)
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <span>over the last</span>

          <mat-form-field class="xsmall">
            <mat-label for="intervalCount"># of intervals</mat-label>
            <input
              matInput
              type="number"
              name="intervalCount"
              formControlName="intervalCount"
            />
          </mat-form-field>
          <mat-form-field class="xsmall">
            <mat-label>Length of Interval</mat-label>
            <mat-select formControlName="intervalType" name="intervalType">
              <mat-option *ngFor="let type of intervalTypes" [value]="type">
                {{ type }}{{ monitorForm.value.intervalCount > 1 ? "s" : "" }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <span>.</span>
        </div>
      </div>
    </div>
    <div id="trigger-container">
      <div id="trigger-title">
        <h4>Notification Settings</h4>
        <button
          mat-button
          (click)="addTrigger()"
          aria-label="button that adds a new trigger"
        >
          <mat-icon>add</mat-icon> new trigger
        </button>
      </div>

      <div formArrayName="triggers">
        <p class="help-text" *ngIf="triggers.length === 0">
          Must have at least one
        </p>
        <div *ngFor="let trigger of triggers.controls; let i = index">
          <div
            [formGroupName]="i"
            class="trigger"
            *ngIf="
              !trigger.value.id ||
              trigger.value.min ||
              trigger.value.max ||
              trigger.level
            "
          >
            <div class="trigger-form">
              <ng-container *ngIf="i > 0">
                <mat-form-field class="xsmall">
                  <mat-label for="val1">min:</mat-label>
                  <input
                    matInput
                    type="number"
                    name="val1"
                    formControlName="val1"
                  />
                </mat-form-field>
                <mat-form-field class="xsmall">
                  <mat-label for="val2">max:</mat-label>
                  <input
                    matInput
                    type="number"
                    name="val2"
                    formControlName="val2"
                  />
                </mat-form-field>
                <mat-form-field class="xsmall">
                  <mat-label for="value_operator">operator</mat-label>
                  <mat-select
                    formControlName="value_operator"
                    name="value_operator"
                  >
                    <mat-option
                      *ngFor="let o of value_operators"
                      [value]="o.value"
                    >
                      {{ o.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field class="xsmall">
                  <mat-label for="num_channels">num_channels:</mat-label>
                  <input
                    matInput
                    type="number"
                    name="num_channels"
                    formControlName="num_channels"
                  />
                </mat-form-field>
                <mat-form-field class="xsmall">
                  <mat-label for="num_channels_operator"
                    >num_channels_operator</mat-label
                  >
                  <mat-select
                    formControlName="num_channels_operator"
                    name="num_channels_operator"
                  >
                    <mat-option
                      *ngFor="let n of num_channels_operators"
                      [value]="n.value"
                    >
                      {{ n.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </ng-container>
              <mat-checkbox
                name="alert_on_out_of_alarm"
                formControlName="alert_on_out_of_alarm"
              >
                <span>Alert on Out of Alarm</span>
              </mat-checkbox>
              <ng-template #noInclusive>
                set {{ trigger.value.min !== null ? "max" : "min" }} for band
              </ng-template>
              <mat-form-field>
                <mat-label for="email_list">email list:</mat-label>
                <input
                  matInput
                  type="email"
                  name="email_list"
                  formControlName="email_list"
                />
                <mat-hint>Comma separated, no spaces</mat-hint>
              </mat-form-field>
              <button
                mat-icon-button
                color="warn"
                (click)="removeTrigger(i)"
                aria-label="button that removes the trigger"
              >
                <mat-icon> delete </mat-icon>
              </button>
            </div>

            <div class="trigger-help">
              <span
                *ngIf="trigger.value.min !== null || trigger.value.max !== null"
              >
                Will be in alarm when
              </span>
              <span
                *ngIf="trigger.value.min !== null && trigger.value.max !== null"
              >
                value {{ trigger.value.inclusive ? "between" : "not between" }}
                {{ trigger.value.min }} and
                {{ trigger.value.max }}
              </span>
              <span
                *ngIf="trigger.value.min !== null && trigger.value.max === null"
              >
                values < {{ trigger.value.min }}
              </span>
              <span
                *ngIf="trigger.value.max !== null && trigger.value.min === null"
              >
                values > {{ trigger.value.max }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- <div id="chart-container">
    <h4>Preview</h4>
    <app-monitor-chart
      [metric]="monitorForm.value.metric"
      [triggers]="monitorForm.value.triggers"
      [channelGroupId]="monitorForm.value.channelGroup.id"
      [stat]="monitorForm.value.stat"
      [numberChannels]="monitorForm.value.numberChannels"
      [intervalCount]="monitorForm.value.intervalCount"
      [intervalType]="monitorForm.value.intervalType"
      [invert]="monitorForm.value.invert"
      ></app-monitor-chart>
  </div> -->
</div>

<div mat-dialog-actions id="dialog-options">
  <div>
    <button id="save" mat-flat-button color="accent" (click)="save()">
      Save
    </button>
  </div>
  <div>All fields are required.</div>
</div>
