<div class="row space-between">
  <button
    mat-button
    color="primary"
    (click)="previewChannels()"
    matTooltip="Test regular expressions"
    aria-label="Button that searches for channels"
  >
    test regex
  </button>
  <button
    mat-button
    (click)="addRule()"
    matTooltip="Add new regular expressions"
  >
    <mat-icon>add</mat-icon>
    add regex
  </button>
</div>

<form #rulesForm [formGroup]="matchingRulesForm">
  <table formArrayName="rules">
    <tr>
      <th class="narrow">include?</th>
      <th>network</th>
      <th>station</th>
      <th>location</th>
      <th>channel</th>
      <th class="narrow"></th>
    </tr>
    <ng-container *ngFor="let rule of rules.controls; let i = index">
      <tr [formGroupName]="i" class="rule-row">
        <td class="narrow">
          <mat-checkbox
            #isInclude
            formControlName="isInclude"
            (change)="updateRules()"
          >
          </mat-checkbox>
        </td>
        <td>
          <mat-form-field>
            <input
              #networkRegex
              matInput
              formControlName="networkRegex"
              (keyup)="
                rules.controls[i].patchValue({
                  networkRegex: $event.target.value.toUpperCase()
                })
              "
              (focusout)="updateRules()"
            />
          </mat-form-field>
        </td>
        <td>
          <mat-form-field>
            <input
              #stationRegex
              matInput
              formControlName="stationRegex"
              (keyup)="
                rules.controls[i].patchValue({
                  stationRegex: $event.target.value.toUpperCase()
                })
              "
              (focusout)="updateRules()"
            />
          </mat-form-field>
        </td>
        <td>
          <mat-form-field>
            <input
              #locationRegex
              matInput
              formControlName="locationRegex"
              (keyup)="
                rules.controls[i].patchValue({
                  locationRegex: $event.target.value.toUpperCase()
                })
              "
              (focusout)="updateRules()"
            />
          </mat-form-field>
        </td>
        <td>
          <mat-form-field>
            <input
              #channelRegex
              matInput
              formControlName="channelRegex"
              (keyup)="
                rules.controls[i].patchValue({
                  channelRegex: $event.target.value.toUpperCase()
                })
              "
              (focusout)="updateRules()"
            />
          </mat-form-field>
        </td>
        <td class="narrow">
          <button mat-icon-button type="button" (click)="removeRule(i)">
            <mat-icon>close</mat-icon>
          </button>
        </td>
      </tr>
      <tr *ngIf="rules.controls[i].errors as errors">
        <td colspan="6" class="warn-text">
          {{ errors.atLeastOne?.message }}
        </td>
      </tr>
      <ng-container
        *ngFor="let field of ['network', 'station', 'location', 'channel']"
      >
        <tr *ngIf="rules.controls[i].get(field + 'Regex').errors as errors">
          <td colspan="6" class="warn-text">
            {{ errors.invalidRegex?.message }} for {{ field }}
          </td>
        </tr>
      </ng-container>
    </ng-container>
  </table>
</form>
