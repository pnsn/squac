<mat-accordion>
  <mat-expansion-panel expanded="true">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <h3>Regex (optional)</h3>
      </mat-panel-title>
      <mat-panel-description> </mat-panel-description>
    </mat-expansion-panel-header>
    <button mat-button (click)="previewChannels()">test rules</button>
    <button mat-button (click)="addRule()">add rule</button>
    <p class="help-text">
      Channel groups can be defined by sets of regex. Groups will be updated
      daily with any channels that match the expressions.
    </p>
    <form #rulesForm [formGroup]="matchingRulesForm">
      <table formArrayName="rules">
        <tr>
          <th class="narrow">include?</th>
          <th>network</th>
          <th>station</th>
          <th>location</th>
          <th>channel</th>
          <th class="narrow"></th>
        </tr>
        <ng-container *ngFor="let rule of rules.controls; let i = index">
          <tr [formGroupName]="i" class="rule-row">
            <td class="narrow">
              <mat-checkbox
                #isInclude
                formControlName="isInclude"
                (change)="updateRules()"
              >
              </mat-checkbox>
            </td>
            <td>
              <mat-form-field>
                <input
                  #networkRegex
                  matInput
                  formControlName="networkRegex"
                  (keyup)="
                    rules.controls[i].patchValue({
                      networkRegex: $event.target.value.toUpperCase()
                    })
                  "
                  (focusout)="updateRules()"
                />
              </mat-form-field>
            </td>
            <td>
              <mat-form-field>
                <input
                  #stationRegex
                  matInput
                  formControlName="stationRegex"
                  (keyup)="
                    rules.controls[i].patchValue({
                      stationRegex: $event.target.value.toUpperCase()
                    })
                  "
                  (focusout)="updateRules()"
                />
              </mat-form-field>
            </td>
            <td>
              <mat-form-field>
                <input
                  #locationRegex
                  matInput
                  formControlName="locationRegex"
                  (keyup)="
                    rules.controls[i].patchValue({
                      locationRegex: $event.target.value.toUpperCase()
                    })
                  "
                  (focusout)="updateRules()"
                />
              </mat-form-field>
            </td>
            <td>
              <mat-form-field>
                <input
                  #channelRegex
                  matInput
                  formControlName="channelRegex"
                  (keyup)="
                    rules.controls[i].patchValue({
                      channelRegex: $event.target.value.toUpperCase()
                    })
                  "
                  (focusout)="updateRules()"
                />
              </mat-form-field>
            </td>
            <td class="narrow">
              <button mat-icon-button type="button" (click)="removeRule(i)">
                <mat-icon>close</mat-icon>
              </button>
            </td>
          </tr>
          <tr *ngIf="rules.controls[i].get('networkRegex').errors">
            {{
              rules.controls[i].get("networkRegex").errors | json
            }}
          </tr>
        </ng-container>
      </table>
    </form>
  </mat-expansion-panel>
</mat-accordion>
