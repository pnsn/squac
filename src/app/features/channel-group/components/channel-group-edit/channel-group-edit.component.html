<div id="edit-container" class="column gray-border white-background">
  <div class="header-title">
    <h2>
      {{ editMode ? "Edit Channel Group" : "Create Channel Group" }}
    </h2>
    <div id="button-container" class="row space-between">
      <ng-container *ngIf="editMode; else notEditMode">
        <button
          mat-icon-button
          *ngIf="editMode"
          color="warn"
          class="add-btn"
          (click)="onDelete()"
          matTooltip="Delete channel group"
          aria-label="Button that deletes the channel group"
        >
          <mat-icon>delete</mat-icon>
        </button>
        <button
          *ngIf="'update' | able: channelGroup"
          mat-flat-button
          color="accent"
          class="add-btn"
          (click)="save()"
          [disabled]="
            !channelGroupForm.valid ||
            (matchingRules?.length === 0 && autoIncludeChannels.length === 0)
          "
          matTooltip="Save channel group"
          aria-label="Button that saves the changes to the channel group"
        >
          Save
        </button>
      </ng-container>
      <ng-template #notEditMode>
        <button
          *ngIf="'create' | able: 'ChannelGroup'"
          mat-flat-button
          color="accent"
          class="add-btn"
          (click)="save()"
          [disabled]="
            !channelGroupForm.valid ||
            (matchingRules?.length === 0 && autoIncludeChannels.length === 0)
          "
          matTooltip="Create channel group"
          aria-label="Button that creates the channel group"
        >
          Create
        </button>
      </ng-template>

      <button
        mat-icon-button
        (click)="formUnsaved()"
        matTooltip="Cancel editing"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
  <div class="edit-body row">
    <div class="column" id="left-column">
      <div id="add-channel-header" class="row space-between">
        <h3>Add Channels to Group</h3>
        <channel-group-csv-upload
          [(channels)]="selectedChannels"
          (channelsChange)="addChannelsFromCSV($event)"
          [(loading)]="loading"
          [(error)]="error"
        >
        </channel-group-csv-upload>
        <mat-slide-toggle
          [(ngModel)]="showOnlyCurrent"
          (change)="filterCurrent()"
        >
          <span class="help-text">Only Show Current Channels</span>
        </mat-slide-toggle>
      </div>

      <p class="help-text">
        Channel groups can have a fixed set of channels or can be automatically
        updated with channels that match a set of regular expressions. Add
        regular expressions on the right under 'Regex' or below using the
        filters. Add channels by uploading a CSV, searching with the filters, or
        using the map to search within a region.
      </p>
      <p *ngIf="error" class="warn-text">
        {{ error }}
      </p>
      <div id="filter-container">
        <channel-group-filter
          (filtersChanged)="filtersChanged($event)"
          (addFilterToRegex)="addFilterToRegex($event)"
        >
        </channel-group-filter>
      </div>
      <shared-loading *ngIf="loading" [loadingMsg]="loading"> </shared-loading>
      <div class="row channels-row">
        <div class="column lt-gray-border search-results-container">
          <div class="row space-between select-channels-controls">
            <h4>Results ({{ rows.length }})</h4>
            <button mat-button color="accent" (click)="includeChannels()">
              add to included
            </button>
            <button mat-button color="accent" (click)="excludeChannels()">
              add to excluded
            </button>
            <button
              mat-icon-button
              color="accent"
              (click)="undoSelectRemove()"
              [disabled]="!this.changeMade"
              matTooltip="undo last change"
            >
              <mat-icon>undo</mat-icon>
            </button>
          </div>

          <div class="table-container">
            <channel-group-edit-table
              [rows]="rows"
              [selectable]="true"
              [selected]="selectedChannels"
              (selectedChange)="selectRow($event)"
            >
            </channel-group-edit-table>
          </div>
        </div>
        <div id="map-box">
          <channel-group-map
            [autoIncludeChannels]="autoIncludeChannels"
            [autoExcludeChannels]="autoExcludeChannels"
            [searchedChannels]="rows"
            [selectedChannels]="selectedChannels"
            [showChannel]="showChannel"
            [editPage]="true"
            (boundsChange)="updateBounds($event)"
          ></channel-group-map>
        </div>
      </div>
    </div>
    <div class="column" id="right-column">
      <mat-accordion displayMode="flat" multi>
        <mat-expansion-panel expanded="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <h4>Group information</h4>
            </mat-panel-title>
            <mat-panel-description>(required)</mat-panel-description>
          </mat-expansion-panel-header>

          <form [formGroup]="channelGroupForm" class="column">
            <mat-form-field class="channel-group-input" class="medium">
              <input
                matInput
                placeholder="Name"
                formControlName="name"
                required
              />
            </mat-form-field>

            <mat-form-field id="description">
              <textarea
                matInput
                placeholder="Description"
                formControlName="description"
                required
              ></textarea>
            </mat-form-field>
          </form>
        </mat-expansion-panel>

        <mat-expansion-panel expanded="false">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <h4>RegEx Rules ({{ matchingRules.length }})</h4>
            </mat-panel-title>
            <mat-panel-description> (optional) </mat-panel-description>
          </mat-expansion-panel-header>
          <p class="help-text">
            Channel groups can be defined by sets of regular expressions. Groups
            will be updated daily with any channels that match the rules.
          </p>
          <channel-group-matching-rule-edit
            [(matchingRules)]="matchingRules"
            (matchingRuleDeleteIds)="deleteMatchingRules($event)"
            (previewRules)="previewRules($event)"
            [channelGroupId]="channelGroup?.id"
          >
          </channel-group-matching-rule-edit>
        </mat-expansion-panel>

        <mat-expansion-panel expanded="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <h4>Included ({{ autoIncludeChannels.length }})</h4>
            </mat-panel-title>
            <mat-panel-description
              >Channels always in group.</mat-panel-description
            >
          </mat-expansion-panel-header>

          <channel-group-edit-table
            (rowsChange)="updateState()"
            [(rows)]="autoIncludeChannels"
            title="Included Channels"
            [selectable]="false"
          >
          </channel-group-edit-table>
        </mat-expansion-panel>

        <mat-expansion-panel expanded="false">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <h4>Excluded ({{ autoExcludeChannels.length }})</h4>
            </mat-panel-title>
            <mat-panel-description
              >Channels never in group.</mat-panel-description
            >
          </mat-expansion-panel-header>
          <channel-group-edit-table
            (rowsChange)="updateState()"
            [(rows)]="autoExcludeChannels"
            title="Excluded Channels"
            [selectable]="false"
          >
          </channel-group-edit-table>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</div>
