<div class="widget-container" *ngIf="widget">
  <div class="widget-header">
    <h4>{{ widget.name }}</h4>
    <div id="controls">
      <button
        class="text-button"
        mat-button
        [matMenuTriggerFor]="metricMenu"
        color="primary"
      >
        metrics
      </button>
      <button
        class="icon-button"
        mat-icon-button
        [matMenuTriggerFor]="widgetMenu"
        color="primary"
      >
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>

    <mat-menu
      #widgetMenu="matMenu"
      class="mat-menu-dense"
      yPosition="below"
      xPosition="before"
    >
      <button
        mat-menu-item
        (click)="editWidget()"
        *ngIf="'update' | able: widget"
      >
        Edit Widget
      </button>
      <!-- TODO: add option for no dashboards -->
      <button
        mat-menu-item
        [matMenuTriggerFor]="dashboardMenu"
        [matMenuTriggerData]="{ dashboards: dashboards }"
        *ngIf="dashboards && dashboards.length > 0"
      >
        Add Widget to Dashboard
      </button>
      <button
        mat-menu-item
        class="warn"
        (click)="deleteWidget()"
        color="warn"
        *ngIf="'delete' | able: widget"
      >
        Delete Widget
      </button>
    </mat-menu>
  </div>

  <mat-menu #dashboardMenu="matMenu" class="mat-menu-dense">
    <ng-template matMenuContent let-dashboards="dashboards">
      <!-- <button mat-menu-item *ngIf="'create' | able: Dashboard">Create New Dashboard</button> -->
      <ng-container *ngFor="let dashboard of dashboards">
        <button
          mat-menu-item
          (click)="addWidgetToDashboard(dashboard.id)"
          *ngIf="'update' | able: dashboard"
        >
          {{ dashboard.name }}
        </button>
      </ng-container>
    </ng-template>
  </mat-menu>

  <mat-menu #metricMenu="matMenu" class="mat-menu-dense">
    <!-- <[button] mat-menu-item *ngIf="'create' | able: Dashboard">Create New Dashboard</button> -->
    <button
      [ngClass]="{ accent: metricsChanged }"
      mat-menu-item
      (click)="metricsSelected()"
    >
      Update
    </button>
    <ng-container *ngFor="let metric of selected; let i = index">
      <button mat-menu-item (click)="changeMetric($event, metric, i)">
        <ng-container *ngIf="this.widgetType.dimensions"> </ng-container>
        <ng-container *ngIf="widget.properties?.dimensions; else noDimensions">
          <span *ngIf="inDimensions(metric) as dim; else noDimensions">
            {{ dim }}
          </span>
        </ng-container>
        <ng-template #noDimensions>
          <mat-icon>check</mat-icon>
        </ng-template>
        {{ metric.name }}
      </button>
    </ng-container>
    <ng-container *ngFor="let metric of notSelected">
      <mat-icon>check_box_outline_blank</mat-icon>
      <!-- <button mat-menu-item (click)="selectMetric($event, metric)">
        <ng-container *ngIf="widget.properties?.dimensions; else noDimensions">
          <ng-container *ngIf="inDimensions(metric) as dim">
            <span>
              {{ dim }}
            </span>

             && getIndex(metric) > -1 -->
      <!-- </ng-container>
        </ng-container>
        <mat-icon *ngIf="getIndex(metric) > -1; else notSelected"
          >check</mat-icon
        >
        {{ metric.name }}
      </button> -->
    </ng-container>
  </mat-menu>
  <shared-loading *ngIf="loading"> </shared-loading>
  <shared-error *ngIf="error" [errorMsg]="error"></shared-error>
  <div
    class="widget-message"
    *ngIf="widget.metrics && widget.metrics.length === 0"
  >
    <p>Could not load metric. Resource may have been deleted.</p>
  </div>
  <div class="widget-message" *ngIf="!widget.channelGroup">
    <p>Could not load channel group. Resource may have been deleted.</p>
  </div>
  <div *ngIf="!error && !loading && noData" class="widget-message">
    <p>No Data</p>
  </div>
  <div class="widget-content" *ngIf="!loading && !error && !noData">
    <ng-container [ngSwitch]="widget?.type">
      <widget-timeline
        *ngSwitchCase="'timeline'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [selectedMetrics]="selectedMetrics"
        [dataRange]="dataRange"
      >
      </widget-timeline>
      <widget-tabular
        *ngSwitchCase="'tabular'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-tabular>
      <widget-parallel-plot
        *ngSwitchCase="'parallel-plot'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-parallel-plot>
      <widget-timechart
        *ngSwitchCase="'timeseries'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-timechart>
      <widget-map
        *ngSwitchCase="'map'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-map>
      <widget-box-plotselectedMetric
        *ngSwitchCase="'box-plot'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-box-plotselectedMetric>
      <widget-scatter-plot
        *ngSwitchCase="'scatter-plot'"
        class="widget"
        [data]="data"
        [metrics]="widget.metrics"
        [channelGroup]="widget.channelGroup"
        [thresholds]="widget.thresholds"
        [channels]="widget.channelGroup.channels"
        [dataRange]="dataRange"
        [selectedMetrics]="selectedMetrics"
      >
      </widget-scatter-plot>
      <div *ngSwitchDefault class="widget-message">
        <p>
          Error: could not load widget...
          {{ widget?.type }}
        </p>
      </div>
    </ng-container>
  </div>
</div>
