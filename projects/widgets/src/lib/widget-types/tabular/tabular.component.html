<div class="table-container">
  <table
    mat-table
    matSort
    [dataSource]="dataSource"
    multiTemplateDataRows
  >
    <ng-container
      matColumnDef="expand"
      sticky
    >
      <th
        mat-header-cell
        *matHeaderCellDef
        aria-label="row actions"
      >&nbsp;</th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        <button
          *ngIf="!row.parentId"
          aria-label="expand row"
          (click)="(row.children ? expandRow(row) : expandedElement = null); $event.stopPropagation()"
        >
          <span *ngIf="expandedElement !== row">^</span>
          <span *ngIf="expandedElement === row">v</span>
        </button>
      </td>
    </ng-container>

    <ng-container
      matColumnDef="title"
      sticky
    >

      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        {{useStationView ? "Station": "Channel"}}
      </th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        {{row.title}}
      </td>

    </ng-container>
    <ng-container matColumnDef="agg">

      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        # out
      </th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        {{row.channelAgg ?? row.agg}}

      </td>
    </ng-container>
    <ng-container
      *ngFor="let metric of selectedMetrics"
      [matColumnDef]="metric.code"
    >
      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        {{metric.name}}
      </th>
      <td
        mat-cell
        *matCellDef="let row"
        [ngStyle]="{ 'background-color': !showKey || properties.displayType === 'stoplight' ? row.metrics[metric.code]?.color : 'white' }"
      >
        <ng-container *ngIf="row.metrics[metric.code] as metricData; else noValue">
          <ng-container
            [ngTemplateOutlet]="cell"
            [ngTemplateOutletContext]="metricData"
          >
          </ng-container>
        </ng-container>
      </td>
    </ng-container>
    <tr
      mat-header-row
      *matHeaderRowDef="columns; sticky:true"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: columns;"
      [class.example-expanded-row]="expandedElement === row"
      (click)="row.children ? expandRow(row) : expandedElement = null"
    >
    </tr>
  </table>
</div>

<ng-template
  #cell
  let-value="value"
  let-color="color"
>
  <ng-container *ngIf="value !== null; else noValue">
    <span
      *ngIf="properties.displayType === 'stoplight'; else notStoplight"
      class="cell-full"
      [ngStyle]="{ 'background-color': color }"
    ></span>
    <ng-template #notStoplight>
      <div
        *ngIf="showKey"
        class="cell-icon"
        [ngStyle]="{ 'background-color': color }"
      ></div>
      <span *ngIf="showKey">{{ value | precision }}</span>
      <div
        *ngIf="!showKey"
        class="cell-full"
        [ngStyle]="{ 'background-color': color, color }"
      >
        <span>
          {{ value | precision }}
        </span>
      </div>

    </ng-template>
  </ng-container>


</ng-template>


<ng-template #noValue>
  <span>no data</span>
</ng-template>