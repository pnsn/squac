<div class="table-container">
  <table
    mat-table
    matSort
    [dataSource]="dataSource"
    multiTemplateDataRows
  >
    <ng-container matColumnDef="expand">
      <th
        mat-header-cell
        *matHeaderCellDef
        aria-label="row actions"
      >&nbsp;</th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        <button
          *ngIf="!row.parentId"
          aria-label="expand row"
          (click)="(row.children ? expandRow(row) : expandedElement = null); $event.stopPropagation()"
        >
          <span *ngIf="expandedElement !== row">^</span>
          <span *ngIf="expandedElement === row">v</span>
        </button>
      </td>
    </ng-container>

    <ng-container
      matColumnDef="title"
      sticky
    >

      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        {{useStationView ? "Station": "Channel"}}
      </th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        {{row.title}}
      </td>

    </ng-container>
    <ng-container matColumnDef="agg">

      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        # out
      </th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        {{row.agg}}

      </td>
    </ng-container>
    <ng-container
      *ngFor="let metric of selectedMetrics"
      [matColumnDef]="metric.code"
    >
      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
      >
        {{metric.name}}
      </th>
      <td
        mat-cell
        *matCellDef="let row"
      >
        <ng-container *ngIf="row.metrics[metric.code] as metricData; else noValue">
          <ng-container
            [ngTemplateOutlet]="cell"
            [ngTemplateOutletContext]="metricData"
          >
          </ng-container>
        </ng-container>
      </td>
    </ng-container>
    <tr
      mat-header-row
      *matHeaderRowDef="columns; sticky:true"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: columns;"
      [class.example-expanded-row]="expandedElement === row"
      (click)="row.children ? expandRow(row) : expandedElement = null"
    >
    </tr>

    <!-- <ng-container *ngIf="expandedElement">
      <ng-container *ngFor="let child of expandedElement.children">
        <tr
          mat-row
          *matRowDef="let row; columns: columns;"
          class="example-detail-row"
        >
        </tr>

      </ng-container>

    </ng-container> -->


    <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
    <ng-container matColumnDef="expandedDetail">
      <ng-container class="example-element-detail">
        <td
          mat-cell
          *matCellDef="let row"
          [attr.colspan]="columns.length"
        >
          <table
            class="element-detail-table"
            mat-table
            [dataSource]="row.children"
            [@detailExpand]="row === expandedElement ? 'expanded' : 'collapsed'"
          >
            <ng-container matColumnDef="title">
              <td
                mat-cell
                *matCellDef="let row"
              >
                {{row.title}}
              </td>
            </ng-container>
            <ng-container matColumnDef="agg">
              <td
                mat-cell
                *matCellDef="let row"
              >
                {{row.agg}}
              </td>
            </ng-container>
            <ng-container
              *ngFor="let metric of selectedMetrics"
              [matColumnDef]="metric.code"
            >
              <td
                mat-cell
                *matCellDef="let row"
              >
                <ng-container *ngIf="row[metric.code] as value; else noValue">
                  <ng-container *ngTemplateOutlet="cell; value">
                  </ng-container>
                </ng-container>
              </td>
            </ng-container>
            <tr
              mat-row
              *matRowDef="let row; columns: columns;"
            ></tr>
          </table>

        </td>

      </ng-container>



    </ng-container>

  </table>
</div>

<ng-template
  #cell
  let-value="value"
  let-color="color"
>
  <ng-container *ngIf="value !== null; else noValue">
    <span
      *ngIf="properties.displayType === 'stoplight'; else notStoplight"
      class="cell-full"
      [ngClass]="{ border: color === 'white' }"
      [ngStyle]="{ 'background-color': color }"
    ></span>
    <ng-template #notStoplight>
      <div
        *ngIf="showKey"
        class="cell-icon"
        [ngClass]="{ border: color === 'white' }"
        [ngStyle]="{ 'background-color': color }"
      ></div>
      <span *ngIf="showKey">{{ value | precision }}</span>
      <div
        *ngIf="!showKey"
        class="cell-full"
        [ngClass]="{
  border: color === 'gray' || color === '#808080'
}"
        [ngStyle]="{ 'background-color': color, color }"
      >
        <span>
          {{ value | precision }}
        </span>
      </div>

    </ng-template>
  </ng-container>


</ng-template>


<ng-template #noValue>
  <span>no data</span>
</ng-template>